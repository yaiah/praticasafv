<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detetives do Tegumento - Sistema Gamificado</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --card-bg-color: #ffffff;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background-color) 0%, #bdc3c7 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .game-title {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-subtitle {
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        /* SISTEMA DE PONTUAÇÃO E BADGES */
        .player-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* SISTEMA DE NÍVEIS */
        .level-system {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .level-bar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .level-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--warning-color));
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* MINIJOGOS */
        .mini-games {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mini-game {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .mini-game:hover {
            transform: translateY(-5px);
        }

        .mini-game h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* JOGO DE MATCHING */
        .matching-game {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .matching-column {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .matching-item {
            background: var(--secondary-color);
            color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .matching-item:hover {
            background: var(--primary-color);
            transform: scale(1.05);
        }

        .matching-item.selected {
            background: var(--accent-color);
            transform: scale(1.1);
        }

        .matching-item.correct {
            background: var(--success-color);
            animation: correctMatch 0.5s ease;
        }

        @keyframes correctMatch {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1.1); }
        }

        /* QUIZ INTERATIVO */
        .quiz-container {
            margin-top: 20px;
        }

        .question {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .option {
            background: var(--secondary-color);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: var(--primary-color);
        }

        .option.correct {
            background: var(--success-color);
        }

        .option.incorrect {
            background: var(--danger-color);
        }

        /* SISTEMA DE CONQUISTAS */
        .achievements {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .achievement {
            background: var(--card-bg-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, var(--gold), #ffa500);
            color: white;
            transform: scale(1.05);
        }

        .achievement-icon {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        .achievement-name {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* RANKING */
        .leaderboard {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .leaderboard h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .rank-position {
            font-weight: bold;
            width: 30px;
            text-align: center;
        }

        .rank-gold { background: linear-gradient(90deg, var(--gold), #ffa500); color: white; }
        .rank-silver { background: linear-gradient(90deg, var(--silver), #a8a8a8); color: white; }
        .rank-bronze { background: linear-gradient(90deg, var(--bronze), #b8860b); color: white; }

        /* BOTÕES */
        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        /* TIMER */
        .timer {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--danger-color);
            margin: 15px 0;
        }

        /* PROGRESS TRACKER */
        .progress-tracker {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .progress-step.completed {
            background: var(--success-color);
        }

        .progress-step.active {
            background: var(--warning-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateX(300px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Estilo para o jogo visual */
        .visual-game-image {
            width: 200px;
            height: 200px;
            background: #ddd;
            border-radius: 10px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #666;
            background-size: cover;
            background-position: center;
        }

        @media (max-width: 768px) {
            .player-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .mini-games {
                grid-template-columns: 1fr;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">🕵️ Detetives do Tegumento</h1>
        <p class="game-subtitle">Desvende os mistérios da evolução através das estruturas tegumentares!</p>
        
        <div class="player-stats">
            <div class="stat-item">
                <span class="stat-number" id="points">0</span>
                <span class="stat-label">Pontos</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="level">1</span>
                <span class="stat-label">Nível</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="achievements">0/12</span>
                <span class="stat-label">Conquistas</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="streak">0</span>
                <span class="stat-label">Sequência</span>
            </div>
        </div>

        <div class="level-system">
            <h4>Progresso do Detetive - Nível <span id="current-level">1</span></h4>
            <div class="level-bar">
                <div class="level-progress" id="level-progress" style="width: 0%"></div>
            </div>
            <p>XP: <span id="current-xp">0</span> / <span id="next-level-xp">100</span></p>
        </div>
    </div>

    <div class="progress-tracker">
        <div class="progress-step active" id="step1">1</div>
        <div class="progress-step" id="step2">2</div>
        <div class="progress-step" id="step3">3</div>
        <div class="progress-step" id="step4">4</div>
        <div class="progress-step" id="step5">5</div>
        <div class="progress-step" id="step6">6</div>
    </div>

    <div class="mini-games">
        <!-- JOGO 1: MATCHING TEGUMENTOS -->
        <div class="mini-game">
            <h3>🧩 Associação de Tegumentos</h3>
            <p>Conecte cada estrutura ao seu grupo correto!</p>
            <div class="timer" id="matching-timer">⏰ 02:00</div>
            <div class="matching-game" id="matching-game">
                <div class="matching-column">
                    <h4>Estruturas</h4>
                    <div class="matching-item" data-id="escamas-placoides">Escamas Placoides</div>
                    <div class="matching-item" data-id="penas">Penas</div>
                    <div class="matching-item" data-id="pelos">Pelos</div>
                    <div class="matching-item" data-id="escamas-elasmoides">Escamas Elasmoides</div>
                </div>
                <div class="matching-column">
                    <h4>Grupos</h4>
                    <div class="matching-item" data-match="escamas-placoides">Chondrichthyes</div>
                    <div class="matching-item" data-match="penas">Aves</div>
                    <div class="matching-item" data-match="pelos">Mamíferos</div>
                    <div class="matching-item" data-match="escamas-elasmoides">Osteichthyes</div>
                </div>
            </div>
            <button class="btn" onclick="resetMatchingGame()">🔄 Reiniciar</button>
        </div>

        <!-- JOGO 2: QUIZ RÁPIDO -->
        <div class="mini-game">
            <h3>⚡ Quiz Relâmpago</h3>
            <p>Teste seus conhecimentos com questões cronometradas!</p>
            <div class="timer" id="quiz-timer">⏰ 00:15</div>
            <div class="quiz-container" id="quiz-container">
                <div class="question" id="current-question">
                    <h4>Qual estrutura é homóloga aos dentes dos vertebrados?</h4>
                    <div class="options">
                        <button class="option" onclick="selectQuizOption(0)">Escamas placoides</button>
                        <button class="option" onclick="selectQuizOption(1)">Escamas elasmoides</button>
                        <button class="option" onclick="selectQuizOption(2)">Penas</button>
                        <button class="option" onclick="selectQuizOption(3)">Pelos</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-success" onclick="nextQuestion()">➡️ Próxima Questão</button>
        </div>

        <!-- JOGO 3: IDENTIFICAÇÃO VISUAL -->
        <div class="mini-game">
            <h3>👁️ Detetive Visual</h3>
            <p>Identifique as estruturas nas imagens microscópicas!</p>
            <div style="text-align: center; margin: 20px 0;">
                <div class="visual-game-image" id="visual-game-image">
                    🔬 Imagem Microscópica
                </div>
            </div>
            <div class="options" id="visual-options">
                <!-- As opções serão carregadas dinamicamente pelo JavaScript -->
            </div>
            <button class="btn btn-warning" onclick="showHint()">💡 Dica</button>
        </div>

        <!-- JOGO 4: CONSTRUÇÃO EVOLUTIVA -->
        <div class="mini-game">
            <h3>🧬 Linha do Tempo Evolutiva</h3>
            <p>Organize as inovações tegumentares na ordem evolutiva!</p>
            <div id="timeline-container" style="min-height: 200px; background: #f8f9fa; border-radius: 10px; padding: 15px;">
                <div class="timeline-item" draggable="true">Pele glandular (Agnatha)</div>
                <div class="timeline-item" draggable="true">Escamas placoides (Chondrichthyes)</div>
                <div class="timeline-item" draggable="true">Escamas elasmoides (Osteichthyes)</div>
                <div class="timeline-item" draggable="true">Queratinização (Sauropsida)</div>
                <div class="timeline-item" draggable="true">Penas/Pelos (Endotermia)</div>
            </div>
            <button class="btn" onclick="checkTimeline()">✅ Verificar Ordem</button>
        </div>
    </div>

    <!-- SISTEMA DE CONQUISTAS -->
    <h3 style="color: var(--primary-color); text-align: center; margin: 30px 0;">🏆 Conquistas Desbloqueadas</h3>
    <div class="achievements" id="achievements-container">
        <div class="achievement" id="ach1">
            <span class="achievement-icon">🔍</span>
            <div class="achievement-name">Primeiro Caso</div>
            <div class="achievement-desc">Complete sua primeira investigação</div>
        </div>
        <div class="achievement" id="ach2">
            <span class="achievement-icon">⚡</span>
            <div class="achievement-name">Velocista</div>
            <div class="achievement-desc">Responda 5 questões em menos de 1 minuto</div>
        </div>
        <div class="achievement" id="ach3">
            <span class="achievement-icon">🎯</span>
            <div class="achievement-name">Precisão Cirúrgica</div>
            <div class="achievement-desc">Acerte 10 questões seguidas</div>
        </div>
        <div class="achievement" id="ach4">
            <span class="achievement-icon">🧬</span>
            <div class="achievement-name">Especialista em Evolução</div>
            <div class="achievement-desc">Complete todos os mini-jogos</div>
        </div>
        <div class="achievement" id="ach5">
            <span class="achievement-icon">🏆</span>
            <div class="achievement-name">Detetive Master</div>
            <div class="achievement-desc">Atinja nível 5</div>
        </div>
        <div class="achievement" id="ach6">
            <span class="achievement-icon">🔥</span>
            <div class="achievement-name">Em Chamas</div>
            <div class="achievement-desc">Mantenha sequência de 15 acertos</div>
        </div>
    </div>

    <!-- RANKING -->
    <div class="leaderboard">
        <h3>🥇 Ranking dos Detetives</h3>
        <div class="rank-item rank-gold">
            <span class="rank-position">1º</span>
            <span>Sherlock Holmes Jr.</span>
            <span>2,850 pts</span>
        </div>
        <div class="rank-item rank-silver">
            <span class="rank-position">2º</span>
            <span>Dr. Watson Bio</span>
            <span>2,340 pts</span>
        </div>
        <div class="rank-item rank-bronze">
            <span class="rank-position">3º</span>
            <span>Inspector Tegumento</span>
            <span>1,890 pts</span>
        </div>
        <div class="rank-item">
            <span class="rank-position">4º</span>
            <span>🔥 VOCÊ</span>
            <span id="your-score">0 pts</span>
        </div>
    </div>

    <div class="notification" id="notification">
        🎉 Conquista desbloqueada!
    </div>

    <script>
// SISTEMA DE GAMIFICAÇÃO COMPLETO
let gameState = {
    points: 0,
    level: 1,
    xp: 0,
    streak: 0,
    achievements: [],
    currentStep: 1,
    matchingTimer: 120,
    quizTimer: 15,
    selectedMatching: null,
    correctMatches: 0,
    matchingTimerInterval: null,
    quizTimerInterval: null,
    questions: [
        {
            question: "Qual estrutura é homóloga aos dentes dos vertebrados?",
            options: ["Escamas placoides", "Escamas elasmoides", "Penas", "Pelos"],
            correct: 0
        },
        {
            question: "O que caracteriza a pele dos anfíbios?",
            options: ["Presença de escamas", "Rica em glândulas mucosas", "Altamente queratinizada", "Presença de pelos"],
            correct: 1
        },
        {
            question: "Qual molécula permitiu a impermeabilização da pele em sauropsidas?",
            options: ["Colágeno", "Quitina", "Queratina", "Elastina"],
            correct: 2
        },
        {
            question: "Qual a diferença entre chifre e haste?",
            options: ["Não há diferença", "Chifre é ósseo, haste é córnea", "Chifre tem base óssea + estojo córneo, haste é totalmente óssea", "Ambas são córneas"],
            correct: 2
        },
        {
            question: "As escamas elasmoides são encontradas em:",
            options: ["Tubarões", "Peixes ósseos", "Répteis", "Anfíbios"],
            correct: 1
        }
    ],
    currentQuestion: 0,
    visualGameImages: [
        {
            description: "Estrutura com dentículos dérmicos pontiagudos",
            answer: "Escama placoide",
            options: ["Escama placoide", "Folículo piloso", "Glândula sebácea", "Estrato córneo"]
        },
        {
            description: "Estrutura ramificada com barbas e bárbulas",
            answer: "Pena",
            options: ["Pena", "Pelo", "Escama ganóide", "Unha"]
        },
        {
            description: "Camada externa queratinizada da pele",
            answer: "Estrato córneo",
            options: ["Estrato córneo", "Derme", "Hipoderme", "Escama"]
        }
    ],
    currentVisualQuestion: 0,
    timelineItems: [
        { text: "Pele glandular (Agnatha)", order: 1 },
        { text: "Escamas placoides (Chondrichthyes)", order: 2 },
        { text: "Escamas elasmoides (Osteichthyes)", order: 3 },
        { text: "Queratinização (Sauropsida)", order: 4 },
        { text: "Penas/Pelos (Endotermia)", order: 5 }
    ]
};

// INICIALIZAÇÃO
document.addEventListener('DOMContentLoaded', function() {
    updateUI();
    initMatchingGame();
    initQuiz();
    initVisualGame();
    initTimeline();
});

// ================ SISTEMA DE MATCHING ================
function initMatchingGame() {
    console.log("Inicializando jogo de matching...");
    
    // Iniciar timer do matching
    gameState.matchingTimerInterval = setInterval(() => {
        gameState.matchingTimer--;
        const timerElement = document.getElementById('matching-timer');
        if (timerElement) {
            timerElement.textContent = `⏰ ${Math.floor(gameState.matchingTimer/60).toString().padStart(2,'0')}:${(gameState.matchingTimer%60).toString().padStart(2,'0')}`;
        }
        
        if (gameState.matchingTimer <= 0) {
            clearInterval(gameState.matchingTimerInterval);
            showNotification('⏰ Tempo esgotado no matching!');
        }
    }, 1000);

    const matchingItems = document.querySelectorAll('.matching-item');
    matchingItems.forEach(item => {
        item.addEventListener('click', handleMatchingClick);
    });
}

function handleMatchingClick() {
    if (this.classList.contains('correct')) return;
    
    // Remover seleção anterior
    document.querySelectorAll('.matching-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    
    if (gameState.selectedMatching === null || gameState.selectedMatching === this) {
        gameState.selectedMatching = this;
        this.classList.add('selected');
    } else {
        const first = gameState.selectedMatching;
        const second = this;
        
        // Verificar se é um match correto
        const isMatch = (first.dataset.id && second.dataset.match === first.dataset.id) ||
                       (first.dataset.match && second.dataset.id === first.dataset.match);
        
        if (isMatch) {
            // Acerto!
            first.classList.remove('selected');
            first.classList.add('correct');
            second.classList.add('correct');
            
            addPoints(50);
            gameState.correctMatches++;
            gameState.streak++;
            
            showNotification('✅ Match correto! +50 pontos');
            
            if (gameState.correctMatches >= 4) {
                unlockAchievement('ach1');
                showNotification('🎉 Parabéns! Matching completo!');
                clearInterval(gameState.matchingTimerInterval);
                nextStep();
            }
        } else {
            // Erro
            first.classList.remove('selected');
            second.classList.add('selected');
            gameState.streak = 0;
            showNotification('❌ Match incorreto. Tente novamente!');
            
            setTimeout(() => {
                second.classList.remove('selected');
            }, 1000);
        }
        
        gameState.selectedMatching = null;
    }
}

function resetMatchingGame() {
    gameState.correctMatches = 0;
    gameState.selectedMatching = null;
    gameState.matchingTimer = 120;
    
    if (gameState.matchingTimerInterval) {
        clearInterval(gameState.matchingTimerInterval);
    }
    
    document.querySelectorAll('.matching-item').forEach(item => {
        item.classList.remove('correct', 'selected');
    });
    
    initMatchingGame();
    showNotification('🔄 Jogo reiniciado!');
}

// ================ SISTEMA DE QUIZ ================
function initQuiz() {
    console.log("Inicializando quiz...");
    loadQuizQuestion();
}

function loadQuizQuestion() {
    const question = gameState.questions[gameState.currentQuestion];
    const quizContainer = document.getElementById('quiz-container');
    
    if (!quizContainer || !question) return;
    
    quizContainer.innerHTML = `
        <div class="question">
            <h4>Questão ${gameState.currentQuestion + 1}/${gameState.questions.length}</h4>
            <p>${question.question}</p>
            <div class="options">
                ${question.options.map((opt, index) => 
                    `<button class="option" onclick="selectQuizOption(${index})">${opt}</button>`
                ).join('')}
            </div>
        </div>
    `;
    
    // Reiniciar timer
    gameState.quizTimer = 15;
    if (gameState.quizTimerInterval) {
        clearInterval(gameState.quizTimerInterval);
    }
    
    gameState.quizTimerInterval = setInterval(() => {
        gameState.quizTimer--;
        const timerElement = document.getElementById('quiz-timer');
        if (timerElement) {
            timerElement.textContent = `⏰ 00:${gameState.quizTimer.toString().padStart(2,'0')}`;
        }
        
        if (gameState.quizTimer <= 0) {
            clearInterval(gameState.quizTimerInterval);
            showNotification('⏰ Tempo esgotado!');
            nextQuestion();
        }
    }, 1000);
}

function selectQuizOption(selectedIndex) {
    clearInterval(gameState.quizTimerInterval);
    
    const question = gameState.questions[gameState.currentQuestion];
    const options = document.querySelectorAll('.quiz-container .option');
    const isCorrect = selectedIndex === question.correct;
    
    options.forEach((option, index) => {
        if (index === question.correct) {
            option.classList.add('correct');
        } else if (index === selectedIndex && !isCorrect) {
            option.classList.add('incorrect');
        }
        option.disabled = true;
    });
    
    if (isCorrect) {
        addPoints(25 + (gameState.quizTimer * 2)); // Bonus por velocidade
        gameState.streak++;
        showNotification(`✅ Correto! +${25 + (gameState.quizTimer * 2)} pontos`);
        
        checkStreakAchievements();
    } else {
        gameState.streak = 0;
        showNotification('❌ Incorreto! A resposta correta foi destacada.');
    }
    
    setTimeout(() => {
        nextQuestion();
    }, 2500);
}

function nextQuestion() {
    gameState.currentQuestion++;
    
    if (gameState.currentQuestion < gameState.questions.length) {
        loadQuizQuestion();
    } else {
        showNotification('🎯 Quiz completo!');
        document.getElementById('quiz-container').innerHTML = `
            <div class="question">
                <h4>🎉 Parabéns! Quiz Finalizado!</h4>
                <p>Você completou todas as questões do quiz.</p>
                <button class="btn btn-success" onclick="restartQuiz()">🔄 Reiniciar Quiz</button>
            </div>
        `;
        nextStep();
    }
}

function restartQuiz() {
    gameState.currentQuestion = 0;
    initQuiz();
}

// ================ JOGO VISUAL ================
function initVisualGame() {
    loadVisualQuestion();
}

function loadVisualQuestion() {
    const visualQuestion = gameState.visualGameImages[gameState.currentVisualQuestion];
    if (!visualQuestion) return;
    
    const optionsContainer = document.getElementById('visual-options');
    const imageContainer = document.getElementById('visual-game-image');
    
    if (optionsContainer && imageContainer) {
        // Atualizar a descrição da imagem
        imageContainer.innerHTML = `🔬 ${visualQuestion.description}`;
        
        // Criar os botões de opção
        optionsContainer.innerHTML = '';
        visualQuestion.options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option';
            button.textContent = option;
            button.onclick = function() {
                selectVisualOption(option, visualQuestion.answer);
            };
            optionsContainer.appendChild(button);
        });
    }
}

function selectVisualOption(selectedOption, correctAnswer) {
    const options = document.querySelectorAll('#visual-options .option');
    let isCorrect = selectedOption === correctAnswer;
    
    options.forEach(option => {
        if (option.textContent === correctAnswer) {
            option.classList.add('correct');
        } else if (option.textContent === selectedOption && !isCorrect) {
            option.classList.add('incorrect');
        }
        option.disabled = true;
    });
    
    if (isCorrect) {
        addPoints(40);
        gameState.streak++;
        showNotification('✅ Identificação correta! +40 pontos');
        checkStreakAchievements();
    } else {
        gameState.streak = 0;
        showNotification(`❌ Incorreto! A resposta era: ${correctAnswer}`);
    }
    
    setTimeout(() => {
        gameState.currentVisualQuestion++;
        if (gameState.currentVisualQuestion < gameState.visualGameImages.length) {
            loadVisualQuestion();
        } else {
            showNotification('👁️ Jogo visual completo!');
            nextStep();
        }
    }, 2500);
}

function showHint() {
    const visualQuestion = gameState.visualGameImages[gameState.currentVisualQuestion];
    const hints = {
        "Escama placoide": "💡 Dica: Estrutura típica de tubarões e raias, com dentículos dérmicos.",
        "Pena": "💡 Dica: Estrutura exclusiva das aves, com barbas e bárbulas.",
        "Estrato córneo": "💡 Dica: Camada mais externa da pele, rica em queratina."
    };
    
    const hint = hints[visualQuestion.answer] || "💡 Pense na origem embriológica da estrutura!";
    showNotification(hint);
    addPoints(-5); // Pequena penalização por usar dica
}

// ================ TIMELINE EVOLUTIVA ================
function initTimeline() {
    const timelineContainer = document.getElementById('timeline-container');
    if (!timelineContainer) return;
    
    // Embaralhar items
    const shuffledItems = [...gameState.timelineItems].sort(() => Math.random() - 0.5);
    
    timelineContainer.innerHTML = shuffledItems.map((item, index) => 
        `<div class="timeline-item" draggable="true" data-order="${item.order}" data-index="${index}">
            ${item.text}
        </div>`
    ).join('');
    
    // Adicionar estilos para timeline
    const style = document.createElement('style');
    style.textContent = `
        .timeline-item {
            background: var(--secondary-color);
            color: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s ease;
            user-select: none;
        }
        .timeline-item:hover {
            background: var(--primary-color);
            transform: translateX(10px);
        }
        .timeline-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .timeline-item.correct-position {
            background: var(--success-color);
        }
    `;
    document.head.appendChild(style);
    
    // Adicionar funcionalidade de drag and drop
    const timelineItems = timelineContainer.querySelectorAll('.timeline-item');
    timelineItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
    });
}

function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.index);
    e.target.classList.add('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    const fromIndex = e.dataTransfer.getData('text/plain');
    const toElement = e.target.closest('.timeline-item');
    
    if (!toElement) return;
    
    const toIndex = toElement.dataset.index;
    const container = toElement.parentNode;
    const items = Array.from(container.querySelectorAll('.timeline-item'));
    
    const fromElement = items.find(item => item.dataset.index === fromIndex);
    const toElementIndex = items.indexOf(toElement);
    
    if (fromElement && toElementIndex !== -1) {
        container.removeChild(fromElement);
        container.insertBefore(fromElement, toElementIndex < items.indexOf(fromElement) ? toElement : toElement.nextSibling);
    }
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function checkTimeline() {
    const timelineContainer = document.getElementById('timeline-container');
    const items = timelineContainer.querySelectorAll('.timeline-item');
    let correctPositions = 0;
    let allCorrect = true;
    
    items.forEach((item, index) => {
        const expectedOrder = parseInt(item.dataset.order);
        const currentPosition = index + 1;
        
        if (expectedOrder === currentPosition) {
            item.classList.add('correct-position');
            correctPositions++;
        } else {
            item.classList.remove('correct-position');
            allCorrect = false;
        }
    });
    
    if (allCorrect) {
        addPoints(100);
        showNotification('🎉 Timeline perfeita! +100 pontos');
        unlockAchievement('ach4');
        nextStep();
    } else {
        showNotification(`📊 ${correctPositions}/5 posições corretas. Continue tentando!`);
        addPoints(correctPositions * 10);
    }
}

// ================ SISTEMA DE PONTUAÇÃO E PROGRESSÃO ================
function addPoints(points) {
    gameState.points += points;
    gameState.xp += Math.max(points, 0); // XP só aumenta com pontos positivos
    
    // Sistema de níveis
    const xpNeeded = gameState.level * 100;
    if (gameState.xp >= xpNeeded) {
        levelUp();
    }
    
    updateUI();
}

function levelUp() {
    const xpNeeded = gameState.level * 100;
    gameState.level++;
    gameState.xp = gameState.xp - xpNeeded;
    
    showNotification(`🆙 Subiu para o nível ${gameState.level}!`);
    
    if (gameState.level === 5) {
        unlockAchievement('ach5');
    }
    
    // Efeito visual de level up
    document.body.style.animation = 'levelUpFlash 1s ease';
    setTimeout(() => {
        document.body.style.animation = '';
    }, 1000);
}

function checkStreakAchievements() {
    if (gameState.streak === 5) {
        unlockAchievement('ach2');
    }
    if (gameState.streak === 10) {
        unlockAchievement('ach3');
    }
    if (gameState.streak === 15) {
        unlockAchievement('ach6');
    }
}

function unlockAchievement(achievementId) {
    if (!gameState.achievements.includes(achievementId)) {
        gameState.achievements.push(achievementId);
        const achievementElement = document.getElementById(achievementId);
        if (achievementElement) {
            achievementElement.classList.add('unlocked');
        }
        showNotification('🏆 Nova conquista desbloqueada!');
        addPoints(100);
    }
}

function nextStep() {
    if (gameState.currentStep < 6) {
        const currentStepElement = document.getElementById(`step${gameState.currentStep}`);
        if (currentStepElement) {
            currentStepElement.classList.remove('active');
            currentStepElement.classList.add('completed');
        }
        
        gameState.currentStep++;
        
        const nextStepElement = document.getElementById(`step${gameState.currentStep}`);
        if (nextStepElement) {
            nextStepElement.classList.add('active');
        }
        
        if (gameState.currentStep > 6) {
            showNotification('🎊 Parabéns! Você completou todos os desafios!');
            unlockAchievement('ach4');
        }
    }
}

// ================ SISTEMA DE NOTIFICAÇÕES ================
function showNotification(message) {
    const notification = document.getElementById('notification');
    if (notification) {
        notification.textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    } else {
        // Fallback para alert se o elemento não existir
        console.log(message);
    }
}

// ================ ATUALIZAÇÃO DA UI ================
function updateUI() {
    // Atualizar estatísticas
    const elements = {
        'points': gameState.points,
        'level': gameState.level,
        'achievements': `${gameState.achievements.length}/6`,
        'streak': gameState.streak,
        'current-level': gameState.level,
        'current-xp': gameState.xp,
        'next-level-xp': gameState.level * 100,
        'your-score': `${gameState.points} pts`
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
    
    // Atualizar barra de progresso
    const progressBar = document.getElementById('level-progress');
    if (progressBar) {
        const percentage = (gameState.xp / (gameState.level * 100)) * 100;
        progressBar.style.width = `${percentage}%`;
    }
}

// ================ EFEITOS VISUAIS ================
// Adicionar CSS para efeitos visuais
const gameStyles = document.createElement('style');
gameStyles.textContent = `
    @keyframes levelUpFlash {
        0%, 100% { background-color: var(--background-color); }
        50% { background-color: #f1c40f; }
    }
    
    @keyframes correctMatch {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1.1); }
    }
    
    .correct {
        animation: correctMatch 0.5s ease !important;
    }
`;
document.head.appendChild(gameStyles);

// ================ FUNÇÕES GLOBAIS PARA OS BOTÕES ================
window.resetMatchingGame = resetMatchingGame;
window.nextQuestion = nextQuestion;
window.showHint = showHint;
window.checkTimeline = checkTimeline;
window.selectQuizOption = selectQuizOption;
window.selectVisualOption = selectVisualOption;
window.restartQuiz = restartQuiz;

// Log para debug
console.log("Sistema de gamificação carregado com sucesso!");
</script>
</body>
</html>
